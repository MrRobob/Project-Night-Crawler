
name: MongoDB Backup

on:
  schedule:
    - cron: '0 2 * * *' # jeden Tag um 2:00 Uhr nachts
  workflow_dispatch:

env:
  MONGO_URI: ${{ secrets.MONGO_URI }}
  BAA_API_KEY: ${{ secrets.BAA_API_KEY }}
  PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Repository klonen
        uses: actions/checkout@v3

      - name: 🐳 Docker Compose installieren
        run: sudo apt-get update && sudo apt-get install docker-compose -y

      - name: 🚀 MongoDB starten
        run: docker-compose up -d nightcrawler-mongo
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          BAA_API_KEY: ${{ secrets.BAA_API_KEY }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 🛡️ Backup durchführen
        run: bash backup-mongo.sh

      - name: 🧹 Container stoppen
        run: docker-compose down
      
      - name: 📤 Backup als Artefakt hochladen
        uses: actions/upload-artifact@v4
        with:
          name: mongo-backup-${{ github.run_id }}
          path: backups/
          retention-days: 7
